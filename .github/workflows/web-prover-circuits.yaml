name: make web-prover-circuits

on:
  workflow_call:
    outputs:
      version:
        description: "web-prover-circuits version"
        value: ${{ jobs.set_version.outputs.version }}
      cache-key:
        description: "Github CI cache key for web-prover-circuits version"
        value: web-prover-circuits-v${{ jobs.set_version.outputs.version }}

jobs:
  set_version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract web_prover_circuits_version
        id: set-version
        run: |
          version=$(sed -n 's/^web_prover_circuits_version *= *"\(.*\)"/\1/p' Cargo.toml)
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "::notice title=WEB_PROVER_CIRCUITS_VERSION::v$version"

  build:
    runs-on: ubuntu-latest
    needs: set_version
    concurrency:
      group: web-prover-circuits-v${{ needs.set_version.outputs.version }}
      cancel-in-progress: false
    steps:
      - name: Check cache
        id: cached-circuits
        uses: actions/cache@v4
        with:
          path: proofs/web_proof_circuits
          key: web-prover-circuits-v${{ needs.set_version.outputs.version }}
          lookup-only: true # don't download, but still save if cache miss

      - uses: actions/checkout@v4
        if: steps.cached-circuits.outputs.cache-hit != 'true'

      - name: make web-prover-circuits
        if: steps.cached-circuits.outputs.cache-hit != 'true'
        run: cd proofs && make web-prover-circuits
