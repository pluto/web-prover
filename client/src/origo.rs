// logic common to wasm32 and native